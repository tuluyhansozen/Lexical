# Notification Inactivity Taper Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Reduce reminder fatigue for inactive users by tapering local reminder frequency over inactivity days while preserving strong re-engagement for active users.

**Architecture:** Replace repeating fixed reminders with a rolling one-shot reminder horizon (next 14 days) generated by an inactivity-aware policy. Inactivity is derived from latest interactive `ReviewEvent` (explicit/session, excluding implicit exposure), and each future day in the horizon gets a profile-based set of reminder times. Scheduling remains idempotent through deterministic request identifiers and full sync replacement.

**Tech Stack:** Swift, SwiftData, UserNotifications, XCTest (`BanditSchedulerTests`)

---

## Scope and Decisions

- Keep existing reminder clock times as canonical slots: `09:00`, `14:00`, `20:00` local time.
- Add inactivity taper profiles by inactive-day bands:
  - Day 0-1: 3 reminders/day (`09:00`, `14:00`, `20:00`)
  - Day 2-4: 2 reminders/day (`14:00`, `20:00`)
  - Day 5-10: 1 reminder/day (`20:00`)
  - Day 11+: 3 reminders/week (`Tue`, `Thu`, `Sun` at `20:00`)
- Keep article-ready flow unchanged.
- Keep foreground suppression unchanged.
- Keep Settings toggle and authorization gating unchanged.

## Out of Scope

- APNs/push notifications.
- New UX copy screens for taper explanation.
- New notification permission prompt UX.

## Risks

- Timezone/day-boundary bugs in deterministic date generation.
- Duplicate pending reminders if identifiers are not deterministic.
- Over-tapering brand-new users with no review history.

## Mitigations

- Build and test a pure schedule builder with fixed `now`.
- Use deterministic request IDs containing date + slot.
- Treat users with no interactive review history as day-0 inactivity.

---

### Task 1: Add Taper Policy (Pure Logic)

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift`
- Test: `/Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift`

**Step 1: Write the failing tests**

Add tests for slot selection by inactivity day:
- `testReminderSlotsForInactivityDayZeroAreThree`
- `testReminderSlotsForInactivityDayThreeAreTwo`
- `testReminderSlotsForInactivityDaySevenIsOne`
- `testReminderSlotsForInactivityDayTwelveUsesWeeklyPattern`

**Step 2: Run tests to verify failure**

Run:
```bash
swift test --filter BanditSchedulerTests/testReminderSlotsForInactivityDay
```
Expected: compile/test failure because policy helpers are missing.

**Step 3: Implement minimal policy helpers**

Add internal pure helpers:
- `reminderSlots(forInactiveDay:) -> [ReminderSlot]`
- `shouldScheduleWeeklyNudge(forDate:) -> Bool`

Add `ReminderSlot` enum for `0900/1400/2000`.

**Step 4: Run tests to verify pass**

Run:
```bash
swift test --filter BanditSchedulerTests/testReminderSlotsForInactivityDay
```
Expected: PASS.

**Step 5: Commit**

```bash
git add /Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift /Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift
git commit -m "test: add inactivity taper slot policy tests"
```

---

### Task 2: Add Rolling-Horizon Reminder Builder

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift`
- Test: `/Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift`

**Step 1: Write the failing tests**

Add tests for deterministic reminder generation:
- `testBuildRollingRemindersGeneratesExpectedCountForActiveUser`
- `testBuildRollingRemindersTapersAcrossFutureDays`
- `testReminderIdentifiersAreDeterministicByDateAndSlot`

**Step 2: Run tests to verify failure**

Run:
```bash
swift test --filter BanditSchedulerTests/testBuildRollingReminders
```
Expected: FAIL due to missing builder.

**Step 3: Implement minimal builder**

Add internal struct and builder:
- `struct ReminderRequestPlan { id, fireDateComponents, route }`
- `buildReminderPlan(now:lastInteractiveDate:horizonDays:) -> [ReminderRequestPlan]`

Identifier format:
- `LEXICAL_REMINDER_YYYYMMDD_HHMM`

**Step 4: Run tests to verify pass**

Run:
```bash
swift test --filter BanditSchedulerTests/testBuildRollingReminders
```
Expected: PASS.

**Step 5: Commit**

```bash
git add /Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift /Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift
git commit -m "feat: add rolling inactivity-aware reminder plan builder"
```

---

### Task 3: Replace Repeating Reminder Sync With Rolling Sync

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift`
- Test: `/Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift`

**Step 1: Write the failing tests**

Add tests:
- `testSyncSchedulesRollingReminderRequestsInsteadOfRepeatingFixedThree`
- `testSyncRemovesLegacyFixedAndMicrodoseReminderRequests`
- `testSyncIsIdempotentForRollingIdentifiers`

**Step 2: Run tests to verify failure**

Run:
```bash
swift test --filter BanditSchedulerTests/testSyncSchedulesRollingReminderRequests
```
Expected: FAIL with current fixed repeat logic.

**Step 3: Implement minimal sync change**

Update `syncOutOfAppReminderNotifications(...)`:
- Remove all pending reminders owned by app (legacy microdose + fixed IDs + old rolling IDs prefix).
- Build rolling plan for next 14 days.
- Schedule one-shot calendar requests from plan.

Keep existing authorization/toggle gating.

**Step 4: Run tests to verify pass**

Run:
```bash
swift test --filter BanditSchedulerTests/testSync
```
Expected: PASS.

**Step 5: Commit**

```bash
git add /Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift /Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift
git commit -m "feat: migrate reminder sync to rolling inactivity taper schedule"
```

---

### Task 4: Derive Inactivity From Interactive Review Events

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift`
- Test: `/Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift`

**Step 1: Write the failing tests**

Add tests:
- `testLastInteractiveReviewDateIgnoresImplicitExposure`
- `testNoInteractiveHistoryDefaultsToDayZeroInactivity`
- `testInactivityDaysComputedFromLatestInteractiveEvent`

**Step 2: Run tests to verify failure**

Run:
```bash
swift test --filter BanditSchedulerTests/testLastInteractiveReviewDate
```
Expected: FAIL before helper exists.

**Step 3: Implement minimal data helper**

Add helper in `BanditScheduler`:
- `latestInteractiveReviewDate(userId:modelContext:) -> Date?`
- Use `ReviewEvent.isInteractiveReviewState` and exclude `isImplicitExposureState`.

Plug this date into rolling plan builder at sync time.

**Step 4: Run tests to verify pass**

Run:
```bash
swift test --filter BanditSchedulerTests/testInactivity
```
Expected: PASS.

**Step 5: Commit**

```bash
git add /Users/tuluyhan/projects/Lexical/LexicalCore/Services/BanditScheduler.swift /Users/tuluyhan/projects/Lexical/LexicalCoreTests/BanditSchedulerTests.swift
git commit -m "feat: base taper inactivity on interactive review events"
```

---

### Task 5: Keep App-Level Wiring Stable and Refresh Horizon Opportunistically

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/Lexical/LexicalApp.swift`
- Modify: `/Users/tuluyhan/projects/Lexical/Lexical/Features/Settings/SettingsView.swift`
- Modify: `/Users/tuluyhan/projects/Lexical/Lexical/Features/Onboarding/OnboardingFlowView.swift`
- Test: `/Users/tuluyhan/projects/Lexical/LexicalTests` (new focused app-level tests if present harness exists)

**Step 1: Write failing test(s) where feasible**

If app-level harness exists, add test for re-sync on active lifecycle event.
If not feasible, document manual verification checklist in commit note.

**Step 2: Implement minimal wiring**

- Keep launch sync.
- Add re-sync on app becoming active (refresh rolling horizon).
- Keep Settings toggle/onboarding permission behavior unchanged except using rolling sync path.

**Step 3: Run validation**

Run:
```bash
swift test --filter BanditSchedulerTests
swift test
```
Expected: PASS.

**Step 4: Commit**

```bash
git add /Users/tuluyhan/projects/Lexical/Lexical/LexicalApp.swift /Users/tuluyhan/projects/Lexical/Lexical/Features/Settings/SettingsView.swift /Users/tuluyhan/projects/Lexical/Lexical/Features/Onboarding/OnboardingFlowView.swift
git commit -m "chore: refresh rolling reminder horizon on active lifecycle"
```

---

### Task 6: Verification and Rollout Safety

**Files:**
- Modify: `/Users/tuluyhan/projects/Lexical/README.md` (optional short note if notifications behavior is documented)
- Modify: `/Users/tuluyhan/projects/Lexical/docs/project_implementation_plan.md` (if this doc tracks shipped behavior)

**Step 1: Run full verification**

```bash
swift test
```
Expected: full suite green.

**Step 2: Manual smoke on simulator**

- Toggle notifications OFF in Settings -> pending reminder requests removed.
- Toggle ON -> rolling reminders scheduled.
- Simulate inactive cohorts via seeded review dates and validate expected reminder counts.
- Confirm taps still route to Review Session.

**Step 3: Commit docs (if changed)**

```bash
git add /Users/tuluyhan/projects/Lexical/README.md /Users/tuluyhan/projects/Lexical/docs/project_implementation_plan.md
git commit -m "docs: document inactivity taper reminder policy"
```

---

## Test Matrix (Must Pass)

- Reminder policy mapping tests by inactivity band.
- Rolling schedule determinism tests (same input -> same IDs).
- Legacy cleanup tests (microdose + old fixed IDs removed).
- Idempotent sync tests (no duplicate pending requests).
- Authorization/Settings gating tests still pass.
- Existing article-ready scheduling tests still pass.

## Implementation Notes

- Use `@test-driven-development` for every behavior change.
- Use `@verification-before-completion` before claiming done.
- Keep helpers pure and deterministic for easy tests.
- Avoid introducing new user-facing settings in this iteration.

